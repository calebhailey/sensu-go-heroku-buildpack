#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

SENSU_VERSION=5.14.1
SENSU_PLATFORM=linux
SENSU_ARCH=amd64

if [ -f "$ENV_DIR/SENSU_VERSION" ]; then
  SENSU_VERSION=$(cat $ENV_DIR/SENSU_VERSION);
fi

# Setup apt environment
APT_DIR="$BUILD_DIR/.apt"
APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"
APT_REPO_FILE="$BUILDPACK_DIR/etc/datadog.list"
APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

# Create build and run environment
mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"
mkdir -p "$APT_DIR"

# Install dependencies
echo "Updating apt caches for dependencies"
apt-get $APT_OPTIONS update 

echo "Installing dependencies"
DEPS="curl ca-certificates"
apt-get $APT_OPTIONS -y --force-yes -d install --reinstall $DEPS

curl -L https://s3-us-west-2.amazonaws.com/sensu.io/sensu-go/${SENSU_VERSION}/sensu-go_${SENSU_VERSION}_${SENSU_PLATFORM}_${SENSU_ARCH}.tar.gz -o $CACHE_DIR/sensu-go_${SENSU_VERSION}_${SENSU_PLATFORM}_${SENSU_ARCH}.tar.gz
mkdir $CACHE_DIR/bin/
tar -xzf $CACHE_DIR/sensu-go_${SENSU_VERSION}_${SENSU_PLATFORM}_${SENSU_ARCH}.tar.gz -C $CACHE_DIR/bin/
mv $CACHE_DIR/bin/sensu-agent $BUILD_DIR/
rm $CACHE_DIR/sensu-go_${SENSU_VERSION}_${SENSU_PLATFORM}_${SENSU_ARCH}.tar.gz
